<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Product Details</title>
        <link rel="icon" href="LocaalRapid.ico" type="image/x-icon">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
        <link rel="stylesheet" href="product-details_weightable.css">
        <script src="products_weightable.js" defer></script> 
       <script src="products.js" defer></script> 
    </head>
    <body>
        <header>
            <div class="navbar">
                <div class="nav-logo border" onclick="window.location.href='index.html'">
                    <div class="logo-name">LocaalRapid</div>
                    <div class="logo" load="lazy"></div>
                </div>
                
                
                <div class="cart border" onclick="window.location.href='cart.html'">
                    <span class="cart-amount">0</span>
                    <div class="cart-icon">
                        <span><i class="fa-solid fa-cart-arrow-down"></i></span>
                    </div>
                </div>
            </div>
        </header>
        <main>
            <div class="container">
                <div class="product">
                    <div class="product-gallery">
                        <img id="main-image" src="" alt="Product Image" loading="lazy" decoding="async">
                    </div>
                    <div class="product-info" id="product-info">
                        </div>
                </div>
                
                <div class="reviews">
                    <a href="https://forms.gle/o6QnsSHPTd5EUZ2q6" target="_blank" class="feedback-btn">
                        Share Your Experience With Us
                    </a>
                </div>
                
                <div class="recommended-container">
                    <h2>You Might Also Like</h2>
                    <div class="product-scroll" id="recommended-products">
                        </div>
                </div>

                <div class="recommended-container">
                    <h2>More to Explore</h2>
                    <div class="product-scroll" id="random-products-scroll-1">
                        </div>
                </div>

                <div class="recommended-container">
                    <h2>Discover Other Items</h2>
                    <div class="product-scroll" id="random-products-scroll-2">
                        </div>
                </div>
            </div>
            <div class="qa-section">
                    <h2 class="qa-title">Questions & Answers</h2>
                    <div id="qa-display-container">
                        <p class="qa-loading">Loading questions...</p>
                    </div>
                    <div class="qa-form-container">
                        <h3>Have a question? Ask here!</h3>
                        <form id="qa-form">
                            <textarea id="question-input" name="question" placeholder="Type your question about this product..." required></textarea>
                            <div id="qa-message"></div>
                            <button type="submit" id="qa-submit-btn">Submit Question</button>
                        </form>
                    </div>
                </div>
            <div class="reviews-section">
                <h2 class="reviews-title">
                    Verified Customer Reviews
                    <img src="secure.png" alt="Delivery" width="25px" height="25px">
                </h2>

                <div class="reviews-placeholder">
                    <div class="placeholder-stars">
                        <i class="fa-regular fa-star"></i>
                        <i class="fa-regular fa-star"></i>
                        <i class="fa-regular fa-star"></i>
                        <i class="fa-regular fa-star"></i>
                        <i class="fa-regular fa-star"></i>
                    </div>
                    <h3 class="placeholder-heading">Genuine Feedback from Real Buyers</h3>
                    <p class="placeholder-text">
                        We value authenticity. To ensure all reviews are from actual customers, we send a private message or email invitation to leave a review after a product has been purchased and delivered.
                    </p>
                    <p class="placeholder-subtext">
                        Once we receive feedback for this item, you'll see it right here!
                    </p>
                </div>
            </div>

            <section class="why-us-section">
                <h2 class="section-title">The LocaalRapid Advantage</h2>

                <div class="quality-assurance-banner">
                    <div class="quality-icon">
                        <img src="original.png" alt="Assured Quality Icon">
                    </div>
                    <div class="quality-content">
                        <h3>Assured Quality</h3>
                        <p>Fresh Products Guaranteed</p>
                    </div>
                </div>

                <div class="features-grid">

                    <div class="feature-item">
                        <div class="feature-icon">
                            <i class="fa-solid fa-bolt-lightning"></i>
                        </div>
                        <div class="feature-content">
                            <h3>Rapid Express Delivery</h3>
                            <p>Why wait? Get your order delivered in minutes saving you precious time.</p>
                        </div>
                    </div>

                    <div class="feature-item">
                        <div class="feature-icon">
                            <i class="fa-solid fa-shield-halved"></i>
                        </div>
                        <div class="feature-content">
                            <h3>Secure, Verified Payments</h3>
                            <p>We offer flexible options, including Cash on Delivery and a direct manual verification (for now) system for secure payments.</p>
                        </div>
                    </div>

                    <div class="feature-item">
                        <div class="feature-icon">
                            <i class="fa-solid fa-arrows-rotate"></i>
                        </div>
                        <div class="feature-content">
                            <h3>Hassle-Free Replacement & Exchange</h3>
                            <p>Easy replacement and exchange available. See our <a href="Replacement and Exchange Policy.html" class="policy-link">Policy Page</a> for details.</p>
                        </div>
                    </div>

                    <div class="feature-item">
                        <div class="feature-icon">
                            <i class="fa-solid fa-tags"></i>
                        </div>
                        <div class="feature-content">
                            <h3>Unbeatable Value</h3>
                            <p>Access the best prices on quality products, all from your home or your location.</p>
                        </div>
                    </div>

                </div>

                <div class="purchase-protection-banner">
                    <div class="protection-icon">
                        <img src="handshake.png" alt="Purchase Protection Icon">
                    </div>
                    <div class="protection-content">
                        <h3>LocaalRapid Purchase Protection</h3>
                        <p>Shop confidently knowing that if something goes wrong with an order, we've got your back for all eligible purchases.</p>
                    </div>
                </div>
            </section>
        </main>

        <footer>
            <div class="footer-content">
                <p>© 2025 LocaalRapid. All rights reserved.</p>
                </div>
        </footer>

        <script>
// NEW: A robust addToCart function to handle both standard and custom items.

let body = document.querySelector('body');;   // ALWAYS attach to body, works everywhere

let cartMessage = document.createElement("div");
cartMessage.className = "cartMessage";
body.append(cartMessage);

    function addItemToCart(item) {
    try {
        const cart = JSON.parse(localStorage.getItem("cart")) || [];
        
        // For predefined packs, check if one already exists to increase its quantity
        // Custom packs will always be new because they have a timestamp in their ID
        const existingItem = cart.find(cartItem => cartItem.cartItemId === item.cartItemId);
        
        if (existingItem) {
            existingItem.quantity++;
        } else {
            cart.push(item);
        }
        
        localStorage.setItem("cart", JSON.stringify(cart));
        
        if (typeof updateCartCount === 'function') {
            updateCartCount();
        }
            item.name = item.name
    .split(" ")
    .map(w => w.charAt(0).toUpperCase() + w.slice(1))
    .join(" ");

    item.name=item.name.length > 20 ? item.name.substring(0, 20) + "..." : item.name;
    
    cartMessage.style.display= "inline-flex";
    cartMessage.innerHTML = `<span> <i class="fa-solid fa-check" style="color: #50e658ff;font-size: 20px;"></i> ${item.amount} ${item.name} added to cart! </span>`;
    
    setTimeout(() => {
    cartMessage.style.display = "none";
}, 4000); // 4000 ms = 4 seconds
        // alert(`"${item.name}" (${item.amount}) has been added to your cart.`);
    } catch (error) {
        console.error("Could not add item to cart:", error);
    }
}
    function getCart() {
        return JSON.parse(localStorage.getItem("cart")) || []; }
        function saveCart(cart) { localStorage.setItem("cart", JSON.stringify(cart)); }
        function updateCartCount() {
            const cart = getCart();
            const count = cart.reduce((sum, item) => sum + item.quantity, 0);
            document.querySelector(".cart-amount").textContent = count;
        }
    // Single, consolidated event listener for when the page loads
    document.addEventListener('DOMContentLoaded', function() {
        const urlParams = new URLSearchParams(window.location.search);
        const productId = parseInt(urlParams.get("id"));

        const product = weightableProducts.find(p => p.id === productId);

        if (product) {
            // --- 1. Render Main Product Details (No changes here) ---
            document.title = `${product.name} - Details`;
            document.getElementById('main-image').src = product.image;
            document.getElementById('main-image').alt = product.name;

            const productInfoContainer = document.getElementById('product-info');
            productInfoContainer.innerHTML = `
                <h1 class="product-name"><abbr style="text-decoration: none;" title="${product.name}">${product.name}</abbr></h1>
                <div class="product-info-little">
                    <p class="product-subcategory">${product.sub_category}</p>
                    ${product.message ? `<p class="message">${product.message}</p>` : ''}
                </div>
                <p class="price-comparison">Reference Rate: <b>₹${product.price_per_100gm} <del> ₹${product.mrp_per_100gm}</del> / 100gm</b></p>
                <p class="product-location">Home / Staples / ${product.name}</p>
                <div class="calculator">
                    <div class="input-group"><label for="weight-input">Weight:</label><input type="number" id="weight-input" placeholder="e.g., 250"><span>gm</span></div>
                    <div class="input-group"><label for="cost-input">Cost:</label><span>₹</span><input type="number" id="cost-input" placeholder="e.g., 55"></div>
                    <p class="tax">(Inclusive of all taxes)</p>
                </div>
                <div class="predefined-weights-container"></div>
                ${product.leftAmount ? `<p class="left" id="stock-message"><img src="lightning.png" alt="Delivery" width="14px" height="14px"> Limited availability — just ${product.leftAmount} remaining. Don’t miss out!</p>` : ''}
                ${product.delivery_time ? `<p class="delivery_time"><img src="delivery-man.png" alt="Delivery" width="30px" height="30px"> Your order is expected to arrive in approximately ${product.delivery_time} </p>` : ''}
                <div class="product-details"><h2>Product Details</h2><p>${product.details || 'No details available.'}</p></div>
                <button class="add-cart"><i class="fa-solid fa-cart-plus"></i> Add Custom Amount</button>
            `;

            const weightInput = document.getElementById('weight-input');
            const costInput = document.getElementById('cost-input');
            const pricePerGram = product.price_per_100gm / 100;

            weightInput.addEventListener('input', () => {
                const weight = parseFloat(weightInput.value) || 0;
                costInput.value = weight > 0 ? (weight * pricePerGram).toFixed(2) : '';
            });

            costInput.addEventListener('input', () => {
                const cost = parseFloat(costInput.value) || 0;
                weightInput.value = cost > 0 ? (cost / pricePerGram).toFixed(2) : '';
            });
            // --- JAVASCRIPT LOGIC TO CREATE PREDEFINED WEIGHT BUTTONS ---
const weightsContainer = productInfoContainer.querySelector('.predefined-weights-container');

// First, check if the product has the 'available_weights' array
if (product.available_weights && product.available_weights.length > 0) {
    
    // Add a title and a container for the buttons
    weightsContainer.innerHTML = `
        <h3>Or, Select a Pack</h3>
        <div class="weights-options"></div>
    `;
    const optionsDiv = weightsContainer.querySelector('.weights-options');

    // Loop through each available weight and create a button for it
    product.available_weights.forEach(option => {
        const button = document.createElement('button');
        button.className = 'weight-option-btn';
        button.innerHTML = `${option.weight} <span class="price-span">₹${option.price}</span>`;

        // Add 'add to cart' functionality to the button
        button.addEventListener('click', () => {
            // Create a unique ID to prevent cart conflicts
            const uniqueCartId = `${product.id}-${option.weight.replace(/\s/g, '')}`;
            
            const newItem = {
                ...product,
                price: option.price,
                amount: option.weight,
                cartItemId: uniqueCartId,
                quantity: 1
            };
            
            // This function is defined in the next step
            addItemToCart(newItem); 
        });

        optionsDiv.appendChild(button);
    });
}
            // --- MODIFIED CODE BLOCK ---
            // Find your existing '.add-cart' listener...
// REPLACE THIS ENTIRE BLOCK
productInfoContainer.querySelector('.add-cart').addEventListener('click', () => {
    // --- FIX STARTS HERE ---
    // Get the current values from the input fields when the button is clicked
    const weightInput = document.getElementById('weight-input');
    const costInput = document.getElementById('cost-input');
    const finalWeight = parseFloat(weightInput.value);
    const finalCost = parseFloat(costInput.value);
    const mrpPerGram = product.mrp_per_100gm / 100; // Ensure mrpPerGram is defined here

    // Add validation
    if (!finalWeight || !finalCost || finalWeight <= 0 || finalCost <= 0) {
        alert("Please enter a valid weight or cost before adding.");
        return;
    }
    // --- FIX ENDS HERE ---

    const uniqueCartId = `${product.id}-custom-${Date.now()}`;
    const newItem = {
        ...product,
        price: finalCost,
        originalPrice: (finalWeight * mrpPerGram).toFixed(2),
        amount: `${finalWeight.toFixed(2)} gm`,
        cartItemId: uniqueCartId,
        quantity: 1
    };
    
    addItemToCart(newItem);
});

            // --- 2. Populate All Recommendation Sections (No changes here) ---
            displayRecommendedProducts(product);
            displayRandomProducts(productId, 'random-products-scroll-1', 15);
            displayPacketProducts('random-products-scroll-2', 15);
            fetchAndDisplayQA(productId);
            setupQAForm(productId);

        } else {
            document.querySelector('.container').innerHTML = '<h1>Product not found!</h1>';
        }

        updateCartCount();
    });

    // --- ALL HELPER FUNCTIONS BELOW ---

    // Function for Section 1: Same Category (Measurable Products)
  // REPLACE this entire function
function displayRecommendedProducts(currentProduct) {
    const container = document.getElementById('recommended-products');
    if (!container) return;
    const recommendations = weightableProducts
        .filter(p => p.category === currentProduct.category && p.id !== currentProduct.id)
        .sort(() => 0.5 - Math.random()).slice(0, 10);
    if (recommendations.length === 0) {
        container.closest('.recommended-container').style.display = 'none';
        return;
    }
    container.innerHTML = '';
    recommendations.forEach(recProduct => {
        const weightOptionsHTML = recProduct.available_weights.map(w => `<option value="${w.price}">${w.weight}</option>`).join('');
        const cardHTML = `<div class="product-card" data-product-id="${recProduct.id}"><a href="?id=${recProduct.id}"><img src="${recProduct.image}" alt="${recProduct.name}" loading="lazy"><h4 class="product-name"><abbr style="text-decoration: none;" title="${recProduct.name}">${recProduct.name}</abbr></h4></a><p class="price-comparison">(₹${recProduct.price_per_100gm} / 100gm)</p><select class="weight-selector-rec">${weightOptionsHTML}</select><p class="product-price" id="price-rec-${recProduct.id}">₹${recProduct.available_weights[0].price}</p><button class="add-btn-rec">Add to Cart</button></div>`;
        container.innerHTML += cardHTML;
    });

    // --- FIX: Added event listeners ---
    container.querySelectorAll('.weight-selector-rec').forEach(selector => {
        selector.addEventListener('change', (e) => {
            const priceEl = e.target.closest('.product-card').querySelector('.product-price');
            priceEl.textContent = `₹${e.target.value}`;
        });
    });
    container.querySelectorAll('.add-btn-rec').forEach(button => {
        button.addEventListener('click', (e) => {
            const card = e.target.closest('.product-card');
            const productId = parseInt(card.dataset.productId);
            const productToAdd = weightableProducts.find(p => p.id === productId);
            const selector = card.querySelector('.weight-selector-rec');
            const selectedOption = selector.options[selector.selectedIndex];

            const newItem = {
                ...productToAdd,
                price: parseFloat(selectedOption.value),
                amount: selectedOption.text,
                cartItemId: `${productToAdd.id}-${selectedOption.text.replace(/\s/g, '')}`,
                quantity: 1
            };
            addItemToCart(newItem);
        });
    });
}

// REPLACE this entire function too
function displayRandomProducts(currentProductId, containerId, count) {
    const container = document.getElementById(containerId);
    if (!container) return;
    const randomProducts = weightableProducts.filter(p => p.id !== currentProductId).sort(() => 0.5 - Math.random()).slice(0, count);
    container.innerHTML = '';
    randomProducts.forEach(product => {
        const weightOptionsHTML = product.available_weights.map(w => `<option value="${w.price}">${w.weight}</option>`).join('');
        const cardHTML = `<div class="product-card" data-product-id="${product.id}"><a href="?id=${product.id}"><img src="${product.image}" alt="${product.name}" loading="lazy"><h4 class="product-name"><abbr style="text-decoration: none;" title="${product.name}">${product.name}</abbr></h4></a><p class="price-comparison">(₹${product.price_per_100gm} / 100gm)</p><select class="weight-selector-rec">${weightOptionsHTML}</select><p class="product-price" id="price-rec-${product.id}">₹${product.available_weights[0].price}</p><button class="add-btn-rec">Add to Cart</button></div>`;
        container.innerHTML += cardHTML;
    });
    
    // --- FIX: Added event listeners ---
    container.querySelectorAll('.weight-selector-rec').forEach(selector => {
        selector.addEventListener('change', (e) => {
            const priceEl = e.target.closest('.product-card').querySelector('.product-price');
            priceEl.textContent = `₹${e.target.value}`;
        });
    });
    container.querySelectorAll('.add-btn-rec').forEach(button => {
        button.addEventListener('click', (e) => {
            const card = e.target.closest('.product-card');
            const productId = parseInt(card.dataset.productId);
            const productToAdd = weightableProducts.find(p => p.id === productId);
            const selector = card.querySelector('.weight-selector-rec');
            const selectedOption = selector.options[selector.selectedIndex];

            const newItem = {
                ...productToAdd,
                price: parseFloat(selectedOption.value),
                amount: selectedOption.text,
                cartItemId: `${productToAdd.id}-${selectedOption.text.replace(/\s/g, '')}`,
                quantity: 1
            };
            addItemToCart(newItem);
        });
    });
}

    // NEW Function for Section 3: Random (Packet Products)
    // REPLACE this entire function
function displayPacketProducts(containerId, count) {
    const container = document.getElementById(containerId);
    if (!container || typeof packetProducts === 'undefined' || packetProducts.length === 0) {
        const containerWrapper = container.closest('.recommended-container');
        if (containerWrapper) containerWrapper.style.display = 'none';
        return;
    }
    const randomPacketProducts = [...packetProducts].sort(() => 0.5 - Math.random()).slice(0, count);
    container.innerHTML = '';
    randomPacketProducts.forEach(product => {
        const cardHTML = `
            <div class="product-card" data-product-id="${product.id}" data-product-type="packet">
                <a href="product-details.html?id=${product.id}">
                    <img src="${product.image}" alt="${product.name}" loading="lazy">
                    <h4 class="product-name"><abbr style="text-decoration: none;" title="${product.name}">${product.name}</abbr></h4>
                </a>
                <p class="product-amount">${product.amount}</p>
                <div class="packet-price-container">
                    <p class="product-price">₹${product.price}</p>
                    <del class="original-price">₹${product.originalPrice}</del>
                </div>
                <button class="add-btn-rec">Add to Cart</button>
            </div>`;
        container.innerHTML += cardHTML;
    });

    // Event listener logic
    container.querySelectorAll('.add-btn-rec').forEach(button => {
        button.addEventListener('click', function(e) {
            const card = e.target.closest('.product-card');
            const productId = parseInt(card.dataset.productId);
            const productToAdd = packetProducts.find(p => p.id === productId);
            
            if (productToAdd) {
                // --- FIX STARTS HERE ---
                // Create a consistent item object to add to the cart.
                // For standard products, the cartItemId can just be the product's ID.
                const newItem = {
                    ...productToAdd,
                    cartItemId: productToAdd.id, // Use the product ID as the unique identifier
                    quantity: 1
                };
                
                // Call the correct, universal 'addItemToCart' function
                addItemToCart(newItem);
                // --- FIX ENDS HERE ---
            }
        });
    });
}
        // This is the ONLY place the URL should be. This is correct.
const G_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwmcrsVmhl49aq4asoO6k1YzWULJRenTBKIaW6BNTWj_-vhVOEtczCqPE9sKSICsgxV/exec';

/**
 * Fetches existing Q&A for a given product ID and displays them.
 * @param {number} productId The ID of the product.
 */
async function fetchAndDisplayQA(productId) {
    const container = document.getElementById('qa-display-container');
    // Check if the script URL is configured
    if (!G_SCRIPT_URL || G_SCRIPT_URL === 'YOUR_GOOGLE_APPS_SCRIPT_URL') {
        container.innerHTML = '<p class="qa-error">Q&A feature is not configured.</p>';
        return;
    }

    try {
        const response = await fetch(`${G_SCRIPT_URL}?productId=${productId}`);
        const result = await response.json();

        if (result.status === 'success' && result.data.length > 0) {
            container.innerHTML = ''; // Clear loading message
            result.data.forEach(item => {
                const qaPair = document.createElement('div');
                qaPair.className = 'qa-pair';
                qaPair.innerHTML = `
                    <div class="qa-question"><strong>Q:</strong> ${item.question}</div>
                    <div class="qa-answer"><strong>Ans:</strong> ${item.answer}</div>
                `;
                container.appendChild(qaPair);
            });
        } else {
            container.innerHTML = '<p class="qa-none">Be the first to ask a question about this product!</p>';
        }
    } catch (error) {
        console.error('Error fetching Q&A:', error);
        container.innerHTML = '<p class="qa-error">Could not load questions and answers at this time.</p>';
    }
}

/**
 * Sets up the event listener for the Q&A submission form.
 * @param {number} productId The ID of the product.
 */
function setupQAForm(productId) {
    const form = document.getElementById('qa-form');
    const submitBtn = document.getElementById('qa-submit-btn');
    const messageDiv = document.getElementById('qa-message');
    const questionInput = document.getElementById('question-input');

    form.addEventListener('submit', async function(event) {
        event.preventDefault();
        submitBtn.disabled = true;
        submitBtn.textContent = 'Submitting...';
        messageDiv.textContent = '';

        if (!G_SCRIPT_URL || G_SCRIPT_URL === 'YOUR_GOOGLE_APPS_SCRIPT_URL') {
            messageDiv.textContent = 'Q&A feature is not configured.';
            messageDiv.className = 'qa-message-error';
            submitBtn.disabled = false;
            submitBtn.textContent = 'Submit Question';
            return;
        }

        try {
            const response = await fetch(G_SCRIPT_URL, {
                method: 'POST',
                mode: 'cors',
                headers: {
                  'Content-Type': 'text/plain' // As required by Google Apps Script
                },
                body: JSON.stringify({
                    productId: productId,
                    question: questionInput.value
                })
            });

            const result = await response.json();

            if(result.status === 'success') {
                messageDiv.textContent = 'Thank you! Your question has been submitted for review.';
                messageDiv.className = 'qa-message-success';
                questionInput.value = ''; // Clear the textarea
            } else {
                throw new Error(result.message || 'Unknown error');
            }

        } catch (error) {
            messageDiv.textContent = `Submission failed: ${error.message}`;
            messageDiv.className = 'qa-message-error';
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Submit Question';
        }
    });
}
        </script>

    </body>
</html>