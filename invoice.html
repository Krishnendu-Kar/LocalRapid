<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Retail Invoice - LocaalRapid</title>
        <link rel="shortcut icon" href="https://krishnendu-kar.github.io/LocalRapid/LocaalRapid.ico" type="image/x-icon">
        <link rel="icon" href="https://krishnendu-kar.github.io/LocalRapid/LocaalRapid.ico" type="image/x-icon">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Libre+Barcode+39&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { 
            background: #f0f2f5; 
            padding: 15px; 
            font-family: 'Arial', sans-serif; 
            font-size: 12px; 
            -webkit-print-color-adjust: exact;
        }
        
        /* MAIN CONTAINER */
        .invoice-paper {
            background: white;
            width: 100%;
            max-width: 800px; /* Fits phones better than 210mm */
            margin: 0 auto;
            padding: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            border-radius: 8px;
            position: relative;
        }

        /* TYPOGRAPHY */
        h1, h2, h3, h4, h5, h6 { margin: 0; color: #000; }
        .company-logo { font-size: 22px; font-weight: 800; color: #2874f0; font-style: italic; }
        .bold { font-weight: bold; }
        .text-right { text-align: right; }
        .small-text { font-size: 10px; color: #555; }

        /* LAYOUT GRID (Mobile First) */
        .header-top {
            display: flex;
            flex-direction: column; /* Stack on mobile */
            gap: 15px;
            margin-bottom: 20px;
        }
        .header-row { 
            display: flex; 
            flex-direction: column; /* Stack on mobile */
            gap: 20px; 
            margin-bottom: 20px; 
        }
        .address-box { 
            width: 100%; /* Full width on mobile */
            padding: 10px;
            background: #f9f9f9;
            border-radius: 6px;
        }
        
        /* BARCODE */
        .barcode { 
            font-family: 'Libre Barcode 39', cursive; 
            font-size: 36px; 
            line-height: 1; 
            color: #000; 
            white-space: nowrap;
        }

        /* TABLE STYLING */
        .table-responsive {
            overflow-x: auto; /* Scroll on mobile if too wide */
        }
        .invoice-table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 10px; 
            font-size: 11px; 
            min-width: 500px; /* Ensure table doesn't squash too much */
        }
        .invoice-table th { 
            background-color: #f1f1f1; 
            border: 1px solid #ccc; 
            padding: 8px; 
            text-align: left;
            text-transform: uppercase;
            font-size: 10px;
        }
        .invoice-table td { 
            border: 1px solid #ccc; 
            padding: 8px; 
            vertical-align: top;
        }

        /* TOTALS SECTION */
        .totals-container {
            width: 100%;
            display: flex;
            justify-content: flex-end;
            margin-top: -1px;
        }
        .totals-table {
            width: 100%; 
            max-width: 300px; /* Limit width on mobile */
            border-collapse: collapse;
            font-size: 11px;
        }
        .totals-table td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: right;
        }
        .totals-label { font-weight: bold; background: #f9f9f9; }
        .totals-value { font-weight: bold; }

        /* FOOTER */
        .footer-section { 
            margin-top: 30px; 
            border-top: 1px dashed #ccc; 
            padding-top: 15px; 
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .text-success { color: #198754 !important; }

        /* --- DESKTOP VIEW (Larger Screens) --- */
        @media (min-width: 768px) {
            .header-top { 
                flex-direction: row; 
                justify-content: space-between; 
                align-items: flex-start; 
            }
            .header-row { 
                flex-direction: row; 
                justify-content: space-between; 
            }
            .address-box { 
                width: 48%; 
                background: transparent; 
                padding: 0; 
            }
            .invoice-table { min-width: auto; } /* Remove min-width on desktop */
            .footer-section { 
                flex-direction: row; 
                justify-content: space-between; 
            }
        }

        /* --- PRINT SETTINGS (Force A4 Layout) --- */
        @media print {
            body { 
                background: white; 
                padding: 0; 
                margin: 0; 
            }
            .invoice-paper { 
                box-shadow: none; 
                max-width: 100%; 
                width: 100%; 
                margin: 0; 
                padding: 10mm; 
                border-radius: 0;
            }
            .no-print { display: none !important; }
            
            /* Force Desktop Layout for Print */
            .header-top { 
                flex-direction: row !important; 
                justify-content: space-between !important; 
            }
            .header-row { 
                flex-direction: row !important; 
                justify-content: space-between !important; 
            }
            .address-box { 
                width: 48% !important; 
                background: transparent !important; 
                padding: 0 !important; 
            }
            .footer-section { 
                flex-direction: row !important; 
                justify-content: space-between !important; 
            }
            .totals-table { max-width: 40% !important; } /* Align totals to right */
            
            /* Page Break Handling */
            tr { page-break-inside: avoid; }
            .totals-container { page-break-inside: avoid; }
        }
    </style>
</head>
<body>

<div class="invoice-paper">
    
    <div class="header-top">
        <div class="d-flex align-items-center">
            <img src="LocaalRapid.png" alt="Logo" style="height: 45px; width: auto; margin-right: 10px;">
            <div>
                <div class="company-logo">LocaalRapid</div>
                <div style="font-size: 12px; margin-top: 2px;">E-Commerce Store</div>
            </div>
        </div>
        <div class="text-end-responsive"> <div style="font-size: 16px; font-weight: bold; text-align: right;">Retail Invoice</div>
            <div style="text-align: right;">
                <div class="barcode" id="barcodeDisplay">*ORDER*</div>
                <div class="small-text">Order ID: <span id="invId" class="bold">...</span></div>
            </div>
        </div>
    </div>

    <div class="header-row">
        <div class="address-box">
            <div class="bold mb-2" style="border-bottom: 1px solid #ddd; padding-bottom: 4px;">Sold By:</div>
            <div style="line-height: 1.5;">
                <span class="bold" style="font-size: 13px;">LocaalRapid</span><br>
                Radhaballavpur, Tamluk,<br>
                West Bengal - 721627<br>
                India
            </div>
        </div>

        <div class="address-box">
            <div class="bold mb-2" style="border-bottom: 1px solid #ddd; padding-bottom: 4px;">Bill To:</div>
            <div class="bold" id="custName" style="font-size: 13px;">...</div>
            <div class="mt-1">
                <span class="bold">Mobile:</span> <span id="custMobile">...</span>
            </div>
            <div class="mt-2 pt-2 border-top">
                <span class="bold">Date:</span> <span id="invDate">...</span><br>
                <span class="bold">Payment:</span> <span id="payMethod">...</span>
            </div>
        </div>
    </div>

    <div class="table-responsive">
        <table class="invoice-table">
            <thead>
                <tr>
                    <th style="width: 45%">Product Description</th>
                    <th style="width: 15%" class="text-right">Unit Price</th>
                    <th style="width: 10%" class="text-right">Qty</th>
                    <th style="width: 30%" class="text-right">Total</th>
                </tr>
            </thead>
            <tbody id="invItems">
                </tbody>
        </table>
    </div>

    <div class="totals-container">
        <table class="totals-table" id="totalsTableBody">
            <tr style="background-color: #f1f1f1;">
                <td class="totals-label" style="font-size: 13px;">Grand Total</td>
                <td class="totals-value" style="font-size: 13px;">₹<span id="grandTotal">0.00</span></td>
            </tr>
        </table>
    </div>

    <div class="mt-3 small-text" style="font-style: italic;">
        * System Generated Invoice.
    </div>

    <div class="footer-section">
        <div style="flex: 1;">
            <div class="small-text">
                <p class="mb-1 bold">Terms & Conditions:</p>
                <ol style="padding-left: 15px; margin: 0;">
                    <li>This is a computer generated invoice. No signature required.</li>
                    <li>Subject to local jurisdiction (Tamluk, WB).</li>
                </ol>
            </div>
        </div>
        <div style="text-align: right;">
            <div class="company-logo" style="font-size: 16px;">Thank You!</div>
            <div style="font-size: 10px;">Visit us again</div>
        </div>
    </div>

    <div class="text-center mt-5 no-print">
        <button onclick="window.print()" class="btn btn-primary btn-sm px-4">
            <i class="fa-solid fa-print me-2"></i> Print / Download Invoice
        </button>
        <a href="order-success.html" class="btn btn-secondary btn-sm ms-2">
            <i class="fa-solid fa-arrow-left me-1"></i> Back
        </a>
    </div>

</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        let orderData = JSON.parse(sessionStorage.getItem('lastOrderData'));
        if (!orderData) {
            orderData = JSON.parse(localStorage.getItem('lastOrderData'));
        }

        if (!orderData) {
            document.body.innerHTML = "<h3 class='text-center mt-5'>No Invoice Data Found</h3><div class='text-center'><a href='index.html' class='btn btn-primary'>Go Home</a></div>";
            return;
        }

        // Header Info
        document.getElementById('invId').textContent = orderData.orderId;
        document.getElementById('barcodeDisplay').textContent = "*" + orderData.orderId + "*";
        
        const dateSource = orderData.timestamp ? new Date(orderData.timestamp) : new Date();
        document.getElementById('invDate').textContent = dateSource.toLocaleDateString('en-IN', {day:'2-digit', month:'2-digit', year:'numeric'});

        document.getElementById('custName').textContent = orderData.customerName.split(" ").map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(" ");
        const mobile = orderData.mobile;
        const maskedMobile = mobile.replace(/\d(?=\d{4})/g, "*");
        document.getElementById('custMobile').textContent = maskedMobile;

        document.getElementById('payMethod').textContent = orderData.paymentMethod;

        // Items
        const tbody = document.getElementById('invItems');
        const cartItems = orderData.cartItems || [];

        cartItems.forEach(item => {
            const unitPrice = parseFloat(item.price);
            const qty = parseInt(item.quantity);
            const lineTotal = unitPrice * qty;
            item.name = item.name.split(" ").map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(" ");
            
            tbody.innerHTML += `
                <tr>
                    <td>
                        <span class="bold">${item.name}</span> <div class="small-text">[${item.amount}]</div>
                    </td>
                    <td class="text-right">₹${unitPrice.toFixed(2)}</td>
                    <td class="text-right">${qty}</td>
                    <td class="text-right">₹${lineTotal.toFixed(2)}</td>
                </tr>
            `;
        });

        // Footer Calculations
        const totalsTable = document.getElementById('totalsTableBody');
        
        const discount = parseFloat(orderData.discount || 0);
        const deliveryCharge = parseFloat(orderData.deliveryCharge || 0);
        const codCharge = parseFloat(orderData.codCharge || 0);
        const finalTotal = parseFloat(orderData.total || 0);
        const listingPrice = finalTotal + discount;

        function insertTotalRow(label, value, isGreen = false) {
            const row = totalsTable.insertRow(0);
            const colorClass = isGreen ? 'text-success' : '';
            row.innerHTML = `
                <td class="totals-label ${colorClass}">${label}</td>
                <td class="totals-value ${colorClass}">${value}</td>
            `;
        }

        if (codCharge > 0) insertTotalRow("COD Handling Charge", `₹${codCharge.toFixed(2)}`);
        if (deliveryCharge > 0) insertTotalRow("Delivery Charge", `₹${deliveryCharge.toFixed(2)}`);
        if (discount > 0) insertTotalRow("Discount", `- ₹${discount.toFixed(2)}`, true);
        if (discount > 0) insertTotalRow("Listing Price", `₹${listingPrice.toFixed(2)}`);

        document.getElementById('grandTotal').textContent = finalTotal.toFixed(2);
    });
</script>

</body>
</html>