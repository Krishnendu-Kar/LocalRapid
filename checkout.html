<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="description" content="LocaalRapid - Fast, reliable, and secure e-commerce shopping. Get snacks biscuits cake at very low price.">
        <meta name="keywords" content="LocaalRapid, online shopping, fast delivery, secure e-commerce, reliable service, chips, noddles, cake">
        <meta name="author" content="Krishnendu Kar">
        <meta name="robots" content="index, follow">
        <meta property="og:title" content="Checkout - LocaalRapid Official e-commerce website">
        <meta property="og:description" content="Shop snacks faster and safer with LocaalRapid – your trusted e-commerce platform for quick delivery, secure shopping, and reliable service.">
        <meta property="og:image" content="https://krishnendu-kar.github.io/LocalRapid/LocaalRapid.png">
        <meta property="og:url" content="https://krishnendu-kar.github.io/LocalRapid/cart.html">
        <meta property="og:type" content="e-commerce website">
        <meta name="twitter:card" content="https://krishnendu-kar.github.io/LocalRapid/LocaalRapid.png">
        <meta name="twitter:title" content="Snacks - LocaalRapid Official e-commerce websitee">
        <meta name="twitter:description" content="LocaalRapid - Fast, reliable, and secure e-commerce shopping. Get snacks biscuits cake at very low price.">
        <meta name="twitter:image" content="https://krishnendu-kar.github.io/LocalRapid/LocaalRapid.png">
        <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" as="style">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
        <link rel="canonical" href="https://krishnendu-kar.github.io/LocalRapid/cart.html">
        <link rel="shortcut icon" href="https://krishnendu-kar.github.io/LocalRapid/LocaalRapid.ico" type="image/x-icon">
        <link rel="icon" href="https://krishnendu-kar.github.io/LocalRapid/LocaalRapid.ico" type="image/x-icon">
        <link rel="apple-touch-icon" href="https://krishnendu-kar.github.io/LocalRapid/LocaalRapid.ico" sizes="180x180">

        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
        <link rel="stylesheet" href="checkout.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
        <title>Checkout - LocaalRapid Fast & Reliable E-commerce Shopping</title>
    </head>
    <body>
        <div id="loadingOverlay" class="loading-overlay">
            <div class="text-center text-white">
            <div class="spinner-border" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">Loading...</span>
            </div>
            <h5 class="mt-3">Processing your order...</h5>
            </div>
        </div>

        <div class="container-fluid">
            <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
            <div class="container">
                <h1 class="navbar-brand mb-0">
                <i class="bi bi-cart-check me-2"></i>Checkout
                </h1>
                <div class="navbar-nav ms-auto">
                <a class="nav-link text-white me-3" href="index.html">
                    <i class="bi bi-house me-1"></i>Home
                </a>
                <a class="nav-link text-white me-3" href="cart.html">
                    <i class="bi bi-bag me-1"></i>Cart
                </a>
                </div>
            </div>
            </nav>
            <div class="checkout-progress">
                <div class="step active">
                    <div class="circle"><i style="font-size:30px;" class="fa-solid fa-circle-check"></i></div>
                    <p style="color:rgb(60, 109, 255);font-weight:600;">Review</p>
                </div>
                <div class="line"></div>
                <div class="step active">
                    <div class="circle">2</div>
                    <p  style="color:rgb(60, 109, 255);font-weight:800;">Checkout</p>
                </div>
            </div>
            <div id="checkoutSection">
            <div class="row">
                <div class="col-lg-8">
                <form id="checkoutForm">
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="bi bi-person me-2 text-primary"></i>Personal Information</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold" >Full Name *</label>
                                    <input type="text" id="fullName" name="fullName" class="form-control" placeholder="Enter your full name" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold">Mobile Number *</label>
                                    <input type="tel" id="mobileNumber" name="mobileNumber" class="form-control" placeholder="10-digit mobile number" required pattern="[0-9]{10}">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold">Alternative Mobile Number</label>
                                    <input type="tel" id="altMobileNumber" name="altMobileNumber" class="form-control" placeholder="Optional" pattern="[0-9]{10}">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold">Email Address </label>
                                    <input type="email" id="emailAddress" name="emailAddress" class="form-control" placeholder="your.email@example.com">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="bi bi-geo-alt me-2 text-primary"></i>Delivery Address</h5>
                            <button type="button" id="manageAddressesBtn" class="btn btn-outline-primary btn-sm" style="display: none;">
                                <i class="bi bi-pencil-square me-1"></i> Manage
                            </button>
                        </div>
                        <div class="card-body">
                            <div id="addressSelection" class="mb-4" style="display: none;">
                                </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">Full Address *</label>
                                <textarea id="fullAddress" class="form-control" name="fullAddress" rows="3" placeholder="House/Building no, Street, Landmark" required></textarea>
                            </div>
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="form-label fw-bold">City *</label>
                                    <input type="text" id="city" class="form-control" name="city" placeholder="City name" required>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label fw-bold">State *</label>
                                    <input type="text" id="state" class="form-control" name="state" value="West Bengal" required>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label fw-bold">PIN Code *</label>
                                    <input type="number" id="pinCode" class="form-control" name="pinCode" placeholder="6-digit PIN code" required pattern="[0-9]{6}">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="bi bi-credit-card me-2 text-primary"></i>Payment Method</h5>
                        </div>
                        <div class="card-body">
                            <div class="form-check p-3 border rounded mb-3">
                            <input class="form-check-input" type="radio" name="payment" id="cod" value="Cash on Delivery" required>
                            <label class="form-check-label w-100" for="cod">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong><img src="cod.png" alt="COD" width="40px" height="40px"> Cash on Delivery (COD)</strong>
                                        <small class="text-muted d-block">Pay when your order arrives</small>
                                    </div>
                                    <span class="badge bg-warning"> Potentially +₹5 charge</span>
                                </div>
                                    <div id="cod-timer-section" class="mt-2 text-center p-2 rounded bg-light" style="display: none;">
                                        <p class="mb-1 text-success fw-bold">
                                            🎉 Place your order within <span id="cod-timer">01:00</span> and your extra COD charge will refuse!
                                        </p>
                                        <p id="cod-hurry-message" class="mb-0 text-danger fw-bold" style="display: none;">
                                            ⏰ Hurry up! Offer ending soon!
                                        </p>
                                    </div>
                                </label>
                            </div>
                            <div class="form-check p-3 border rounded">
                                <input class="form-check-input" type="radio" name="payment" id="upi" value="UPI Payment" required>
                                <label class="form-check-label w-100" for="upi">
                                    <strong><img src="upi.png" alt="UPI" width="30px" height="30px">UPI Payment</strong>
                                    <small class="text-muted d-block">After placing your order we shall contact you soon for your payment</small>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="form-check mb-4">
                        <input class="form-check-input" type="checkbox" value="" id="saveAddressCheck">
                        <label class="form-check-label" for="saveAddressCheck">
                            Save this address for future use
                        </label>
                    </div>

                    <div class="d-grid">
                        <button type="submit" class="btn btn-success btn-lg">
                            <i class="bi bi-check-circle me-2"></i>Place Order
                        </button>
                    </div>
                </form>
                </div>
                <div class="col-lg-4">
                    <div class="card sticky-top">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">
                                <i class="bi bi-receipt me-2"></i>Order Summary
                            </h5>
                        </div>
                        <div class="card-body">
                            <div id="checkout-cart-items">
                                <p class="text-muted">Loading cart...</p>
                            </div>
                            <hr>
                            <div id="price-breakdown">
                                <div class="d-flex justify-content-between mb-2 text-muted" id="summary-listing-price-row" style="display: none;">
                                    <span>Listing Price</span>
                                    <span>₹<span id="summary-listing-price">0.00</span></span>
                                </div>
                                <div class="d-flex justify-content-between mb-2 text-success" id="summary-discount-row" style="display: none;">
                                    <span>Discount</span>
                                    <span>- ₹<span id="summary-discount">0.00</span></span>
                                </div>
                                <div class="d-flex justify-content-between mb-2" id="summary-delivery-row" style="display: none;">
                                    <span>Delivery Charge</span>
                                    <span>+ ₹<span id="summary-delivery">0.00</span></span>
                                </div>
                                <div class="d-flex justify-content-between mb-2 text-warning" id="summary-cod-row" style="display: none;">
                                    <span>COD Charge (if offer not applied)</span>
                                    <span>+ ₹<span id="summary-cod">5.00</span></span>
                                </div>
                            </div>
                            <hr>
                            <div class="d-flex justify-content-between align-items-center">
                                <h4 class="mb-0">Total:</h4>
                                <h4 class="mb-0 text-success">₹<span id="checkout-total">0</span></h4>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            </div>
        </div>
        
        <div id="manageAddressModal" class="address-modal-overlay">
            <div class="address-modal-content">
                <div class="address-modal-header">
                    <h4>Manage Saved Addresses</h4>
                    <button id="closeModalBtn" class="btn-close">&times;</button>
                </div>
                <div id="addressList" class="address-modal-body">
                    </div>
            </div>
        </div>
        
        <script>
            // --- CONSTANTS & GLOBAL STATE ---
            const MAX_ADDRESSES = 4;
            let currentEditId = null; // To track which address is being edited
            let codTimerInterval;

            // --- CORE ADDRESS MANAGEMENT FUNCTIONS (using localStorage) ---
            function getAddresses() {
                return JSON.parse(localStorage.getItem('savedAddresses')) || [];
            }

            function saveAddresses(addresses) {
                localStorage.setItem('savedAddresses', JSON.stringify(addresses));
            }

            function saveAddress(addressData) {
                let addresses = getAddresses();
                const existingIndex = addresses.findIndex(a => a.id === addressData.id);

                if (existingIndex > -1) { // Update existing
                    addresses[existingIndex] = addressData;
                } else { // Add new
                    if (addresses.length >= MAX_ADDRESSES) {
                        alert(`You can only save a maximum of ${MAX_ADDRESSES} addresses.`);
                        return;
                    }
                    addressData.id = Date.now(); // Assign a new unique ID
                    addresses.push(addressData);
                }
                saveAddresses(addresses);
            }

            function deleteAddress(addressId) {
                if (confirm('Are you sure you want to delete this address?')) {
                    let addresses = getAddresses();
                    const updatedAddresses = addresses.filter(a => a.id !== addressId);
                    saveAddresses(updatedAddresses);
                    renderAddressSelector(); // Re-render the selection radio buttons
                    renderManageAddressesModal(); // Re-render the list in the modal
                }
            }

            // --- COD TIMER FUNCTIONS ---
            function startCodTimer() {
                const oneMinute = 1 * 60 * 1000;
                let timerEndTime = sessionStorage.getItem('codTimerEndTime');

                if (!timerEndTime) {
                    console.log("COD timer started for the first time this session.");
                    timerEndTime = Date.now() + oneMinute;
                    sessionStorage.setItem('codTimerEndTime', timerEndTime);
                }

                document.getElementById('cod-timer-section').style.display = 'block';
                document.getElementById('summary-cod-row').style.display = 'flex'; // Show in summary
                clearInterval(codTimerInterval); // Prevent multiple intervals

                codTimerInterval = setInterval(() => {
                    const remaining = timerEndTime - Date.now();

                    if (remaining <= 0) {
                        clearInterval(codTimerInterval);
                        document.getElementById('cod-timer-section').innerHTML = '<p class="text-danger fw-bold">😔 The offer has expired. A ₹5 charge will apply for choosing COD.</p>';
                        return;
                    }

                    if (remaining < 0.5 * 60 * 1000) { // Show "Hurry up" in last 30 seconds
                        document.getElementById('cod-hurry-message').style.display = 'block';
                    } else {
                        document.getElementById('cod-hurry-message').style.display = 'none';
                    }

                    const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((remaining % (1000 * 60)) / 1000);
                    const formattedTime = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                    document.getElementById('cod-timer').textContent = formattedTime;
                }, 1000);
            }

            function stopCodTimer() {
                clearInterval(codTimerInterval);
                document.getElementById('cod-timer-section').style.display = 'none';
                document.getElementById('summary-cod-row').style.display = 'none'; // Hide from summary
            }

            // --- UI RENDERING & INTERACTION FUNCTIONS ---
            function loadCheckoutCart() {
                const cart = JSON.parse(sessionStorage.getItem('checkoutCart')) || [];
                const cartContainer = document.getElementById('checkout-cart-items');
                
                // ✅ FIX: Redirect if cart is empty
                if (cart.length === 0) {
                    alert("Your checkout cart is empty. Redirecting to the homepage.");
                    window.location.href = 'index.html';
                    return; // Stop further execution
                }

                const subtotal = parseFloat(sessionStorage.getItem('checkoutSubtotal') || 0);
                const listingPrice = parseFloat(sessionStorage.getItem('checkoutListingPrice') || 0);
                const discount = parseFloat(sessionStorage.getItem('checkoutDiscount') || 0);
                const deliveryCharge = parseFloat(sessionStorage.getItem('checkoutDeliveryCharge') || 0);
                const totalPrice = subtotal + deliveryCharge;

                let cartHTML = "";
                cart.forEach(item => {
                    cartHTML += `<div class="d-flex justify-content-between mb-2"><span>${item.name} [${item.amount}] (x${item.quantity})</span><span class="fw-bold">₹${(item.price * item.quantity).toFixed(2)}</span></div>`;
                });
                cartContainer.innerHTML = cartHTML;

                if (discount > 0) {
                    document.getElementById('summary-listing-price').textContent = listingPrice.toFixed(2);
                    document.getElementById('summary-discount').textContent = discount.toFixed(2);
                    document.getElementById('summary-listing-price-row').style.display = 'flex';
                    document.getElementById('summary-discount-row').style.display = 'flex';
                }

                if (deliveryCharge > 0) {
                    document.getElementById('summary-delivery').textContent = deliveryCharge.toFixed(2);
                    document.getElementById('summary-delivery-row').style.display = 'flex';
                }

                document.getElementById('checkout-total').textContent = totalPrice.toFixed(2);
            }

            function populateForm(address) {
                currentEditId = address ? address.id : null;
                document.getElementById('fullName').value = address ? address.fullName : '';
                document.getElementById('mobileNumber').value = address ? address.mobileNumber : '';
                document.getElementById('altMobileNumber').value = address ? address.altMobileNumber : '';
                document.getElementById('emailAddress').value = address ? address.emailAddress : '';
                document.getElementById('fullAddress').value = address ? address.fullAddress : '';
                document.getElementById('city').value = address ? address.city : '';
                document.getElementById('state').value = address ? address.state : 'West Bengal';
                document.getElementById('pinCode').value = address ? address.pinCode : '';
                document.getElementById('saveAddressCheck').checked = !address; // Uncheck if populating an existing address
            }

            function renderAddressSelector() {
                const addresses = getAddresses();
                const container = document.getElementById('addressSelection');
                const manageBtn = document.getElementById('manageAddressesBtn');

                if (addresses.length === 0) {
                    container.style.display = 'none';
                    manageBtn.style.display = 'none';
                    populateForm(null); // Clear the form
                    return;
                }

                container.style.display = 'block';
                manageBtn.style.display = 'block';
                container.innerHTML = ''; // Clear previous options

                addresses.forEach((addr, index) => {
                    container.innerHTML += `
                        <div class="address-option">
                            <input class="form-check-input" type="radio" name="selectedAddress" id="addr_${addr.id}" value="${addr.id}" ${index === 0 ? 'checked' : ''}>
                            <label for="addr_${addr.id}">
                                <strong>Address ${index + 1}</strong>
                                <span class="address-option-details">${addr.fullAddress}, ${addr.city} - ${addr.pinCode}</span>
                            </label>
                        </div>`;
                });

                container.innerHTML += `
                    <div class="address-option">
                        <input class="form-check-input" type="radio" name="selectedAddress" id="addr_new" value="new">
                        <label for="addr_new">
                            <strong><i class="bi bi-plus-circle me-1"></i> Add a New Address</strong>
                        </label>
                    </div>`;

                document.querySelectorAll('input[name="selectedAddress"]').forEach(radio => {
                    radio.addEventListener('change', (e) => {
                        const selectedId = e.target.value;
                        if (selectedId === 'new') {
                            populateForm(null);
                        } else {
                            const selectedAddr = addresses.find(a => a.id == selectedId);
                            populateForm(selectedAddr);
                        }
                    });
                });
                populateForm(addresses[0]); // Initially populate form with the first address
            }

            function renderManageAddressesModal() {
                const addresses = getAddresses();
                const listContainer = document.getElementById('addressList');
                listContainer.innerHTML = '';

                if (addresses.length === 0) {
                    listContainer.innerHTML = '<p class="text-muted">You have no saved addresses.</p>';
                    return;
                }

                addresses.forEach(addr => {
                    listContainer.innerHTML += `
                        <div class="saved-address-item" data-id="${addr.id}">
                            <div class="saved-address-details">
                                <p><strong>${addr.fullName}</strong>, ${addr.mobileNumber}</p>
                                <p class="text-muted">${addr.fullAddress}, ${addr.city}, ${addr.state} - ${addr.pinCode}</p>
                            </div>
                            <div class="saved-address-actions">
                                <button type="button" class="btn btn-outline-primary btn-sm edit-btn">Edit</button>
                                <button type="button" class="btn btn-outline-danger btn-sm delete-btn">Delete</button>
                            </div>
                        </div>`;
                });

                listContainer.querySelectorAll('.edit-btn').forEach(btn => {
                    btn.addEventListener('click', e => {
                        const id = e.target.closest('.saved-address-item').dataset.id;
                        const addrToEdit = getAddresses().find(a => a.id == id);
                        populateForm(addrToEdit);
                        document.getElementById('addr_' + id).checked = true;
                        document.getElementById('manageAddressModal').style.display = 'none';
                        document.getElementById('saveAddressCheck').checked = true; // Pre-check "save" to enable updating
                    });
                });

                listContainer.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', e => {
                        const id = e.target.closest('.saved-address-item').dataset.id;
                        deleteAddress(Number(id));
                    });
                });
            }

            // --- INITIALIZATION & EVENT LISTENERS ---
            document.addEventListener("DOMContentLoaded", function() {
                loadCheckoutCart();
                renderAddressSelector();

                document.getElementById('cod').addEventListener('change', startCodTimer);
                document.getElementById('upi').addEventListener('change', stopCodTimer);

                const modal = document.getElementById('manageAddressModal');
                const manageBtn = document.getElementById('manageAddressesBtn');
                const closeModalBtn = document.getElementById('closeModalBtn');
                
                manageBtn.addEventListener('click', () => {
                    renderManageAddressesModal();
                    modal.style.display = 'flex';
                    setTimeout(() => { 
                        modal.style.opacity = 1; 
                        modal.querySelector('.address-modal-content').style.transform = 'scale(1)';
                    }, 10);
                });

                const closeModal = () => {
                    modal.style.opacity = 0;
                    modal.querySelector('.address-modal-content').style.transform = 'scale(0.95)';
                    setTimeout(() => { modal.style.display = 'none'; }, 300);
                };

                closeModalBtn.addEventListener('click', closeModal);
                modal.addEventListener('click', e => {
                    if (e.target === modal) closeModal();
                });

                document.getElementById("checkoutForm").addEventListener("submit", function(e) {
                    e.preventDefault();
                    
                    // ✅ FEATURE: Show loader immediately for better UX
                    document.getElementById('loadingOverlay').style.display = 'flex';
                    document.body.style.cursor = 'wait';

                    const form = e.target;
                    const hideLoader = () => {
                        document.getElementById('loadingOverlay').style.display = 'none';
                        document.body.style.cursor = 'default';
                    };
                    
                    // ✅ FEATURE: More robust JS validation
                    const mobileNumber = document.getElementById("mobileNumber").value;
                    const pinCode = document.getElementById("pinCode").value;
                    if (!/^[0-9]{10}$/.test(mobileNumber)) {
                        alert("Please enter a valid 10-digit mobile number.");
                        hideLoader();
                        return;
                    }
                    if (!/^[0-9]{6}$/.test(pinCode)) {
                        alert("Please enter a valid 6-digit PIN code.");
                        hideLoader();
                        return;
                    }
                    if (!document.querySelector("input[name='payment']:checked")) {
                        alert("Please select a payment method.");
                        hideLoader();
                        return;
                    }

                    if (document.getElementById('saveAddressCheck').checked) {
                        const addressData = {
                            id: currentEditId,
                            fullName: document.getElementById('fullName').value.trim(),
                            mobileNumber: document.getElementById('mobileNumber').value.trim(),
                            altMobileNumber: document.getElementById('altMobileNumber').value.trim(),
                            emailAddress: document.getElementById('emailAddress').value.trim(),
                            fullAddress: document.getElementById('fullAddress').value.trim(),
                            city: document.getElementById('city').value.trim(),
                            state: document.getElementById('state').value.trim(),
                            pinCode: document.getElementById('pinCode').value.trim()
                        };
                        saveAddress(addressData);
                    }

                    const cart = JSON.parse(sessionStorage.getItem('checkoutCart')) || [];
                    const subTotal = parseFloat(sessionStorage.getItem('checkoutSubtotal') || "0");
                    const deliveryCharge = parseFloat(sessionStorage.getItem('checkoutDeliveryCharge') || "0");
                    const discount = parseFloat(sessionStorage.getItem('checkoutDiscount') || "0");
                    // ✅ BUG FIX: Retrieve listingPrice here to use it in the success message
                    const listingPrice = parseFloat(sessionStorage.getItem('checkoutListingPrice') || "0");
                    let codCharge = 0;
                    const paymentMethod = document.querySelector("input[name='payment']:checked").value;
                    const timerEndTime = sessionStorage.getItem('codTimerEndTime');

                    if (paymentMethod === "Cash on Delivery" && (!timerEndTime || Date.now() > timerEndTime)) {
                        codCharge = 5;
                    }
                    const totalPrice = subTotal + deliveryCharge + codCharge;
                    const orderSummaryText = cart.map(item => 
                        `${item.name} [${item.amount}] | (Qty: ${item.quantity}) ₹${(item.price * item.quantity).toFixed(2)}`
                    ).join('; ');
                    const orderId = 'LP-' + Date.now();

                    const formData = new FormData(form);
                    formData.append('orderId', orderId);
                    formData.append('orderSummary', orderSummaryText);
                    formData.append('discount', discount.toFixed(2));
                    formData.append('paymentMethod', paymentMethod);
                    formData.append('deliveryCharge', deliveryCharge.toFixed(2));
                    formData.append('codCharge', codCharge.toFixed(2));
                    formData.append('total', totalPrice.toFixed(2));
                    
                    const scriptURL = 'https://script.google.com/macros/s/AKfycbyhVYuvC_cyTvQ4QZpPNjxfgrdlzLbWHv8O56_6GB19nxCwDIVc9fKC2ODQS7UuxQ1_8g/exec';

                    fetch(scriptURL, { method: 'POST', body: formData })
                        .then(response => response.json())
                        .then(data => {
                            if (data.result === 'success') {
                                console.log('Success! Data sent to Google Sheet:', data);
                                alert("Order data saved! You will now be redirected to WhatsApp to confirm your order.");

                                let message = ` *New Order Confirmation*\n\n`;
                                message += `*Order ID:* ${orderId}\n\n`;
                                message += ` *Customer:* ${formData.get('fullName')} (${formData.get('mobileNumber')})\n`;
                                message += ` *Address:* ${formData.get('fullAddress')}, ${formData.get('city')}, ${formData.get('state')} - ${formData.get('pinCode')}\n\n`;
                                message += ` *Order Summary:*\n`;
                                cart.forEach(item => {
                                    message += `- ${item.name} [${item.amount}] | Qty: ${item.quantity} | Subtotal: ₹${(item.price * item.quantity).toFixed(2)}\n`;
                                });
                                
                                if (discount > 0) {
                                    message += `\n*Listing Price:* ~₹${listingPrice.toFixed(2)}~\n`;
                                    message += `*Discount:* - ₹${discount.toFixed(2)}\n`;
                                }
                                message += `*Subtotal:* ₹${subTotal.toFixed(2)}\n`;

                                if (deliveryCharge > 0) {
                                    message += `*Delivery Charge:* ₹${deliveryCharge.toFixed(2)}\n`;
                                }
                                message += `*Payment Method:* ${paymentMethod}\n`;
                                if (codCharge > 0) {
                                    message += `*COD Charge:* ₹${codCharge.toFixed(2)}\n`;
                                } else if (paymentMethod === "Cash on Delivery") {
                                    message += `*COD Charge:* ₹0.00 (Offer Applied!)\n`;
                                }
                                message += `\n\t*Grand Total:* ₹${totalPrice.toFixed(2)}\n`;

                                localStorage.removeItem('cart');
                                sessionStorage.clear();

                                const phone = "917797445647";
                                const waUrl = `https://wa.me/${phone}?text=${encodeURIComponent(message)}`;
                                window.location.href = waUrl;

                            } else {
                                throw new Error(data.error || 'An unknown error occurred in the Google Script.');
                            }
                        })
                        .catch(error => {
                            console.error('Fetch Error!', error.message);
                            hideLoader();
                            alert('There was an error saving your order. Please check your connection and try again.');
                        });
                });
            });
        </script>
    </body>
</html>