<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <!-- SEO Meta -->
        <meta name="description" content="LocaalRapid - Fast, reliable, and secure e-commerce shopping. Get snacks biscuits cake at very low price.">
        <meta name="keywords" content="LocaalRapid, online shopping, fast delivery, secure e-commerce, reliable service, chips, noddles, cake">
        <meta name="author" content="Krishnendu Kar">
        <meta name="robots" content="index, follow">
        <!-- Open Graph (Facebook, LinkedIn, WhatsApp) -->
        <meta property="og:title" content="Checkout - LocaalRapid Official e-commerce website">
        <meta property="og:description" content="Shop snacks faster and safer with LocaalRapid ‚Äì your trusted e-commerce platform for quick delivery, secure shopping, and reliable service.">
        <meta property="og:image" content="https://krishnendu-kar.github.io/LocalRapid/LocaalRapid.png">
        <meta property="og:url" content="https://krishnendu-kar.github.io/LocalRapid/cart.html">
        <meta property="og:type" content="e-commerce website">
        <!-- Twitter Card -->
        <meta name="twitter:card" content="https://krishnendu-kar.github.io/LocalRapid/LocaalRapid.png">
        <meta name="twitter:title" content="Snacks - LocaalRapid Official e-commerce websitee">
        <meta name="twitter:description" content="LocaalRapid - Fast, reliable, and secure e-commerce shopping. Get snacks biscuits cake at very low price.">
        <meta name="twitter:image" content="https://krishnendu-kar.github.io/LocalRapid/LocaalRapid.png">
        <!-- Preloads -->
        <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" as="style">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
        <!-- Canonical -->
        <link rel="canonical" href="https://krishnendu-kar.github.io/LocalRapid/cart.html">
        <!-- Favicon & Apple Icon -->
        <link rel="shortcut icon" href="https://krishnendu-kar.github.io/LocalRapid/LocaalRapid.ico" type="image/x-icon">
        <link rel="icon" href="https://krishnendu-kar.github.io/LocalRapid/LocaalRapid.ico" type="image/x-icon">
        <link rel="apple-touch-icon" href="https://krishnendu-kar.github.io/LocalRapid/LocaalRapid.ico" sizes="180x180">

        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
        <link rel="stylesheet" href="checkout.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
        <title>Checkout - LocaalRapid Fast & Reliable E-commerce Shopping</title>
    </head>
    <body>
        <!-- Loading Overlay -->
        <div id="loadingOverlay" class="loading-overlay">
            <div class="text-center text-white">
            <div class="spinner-border" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">Loading...</span>
            </div>
            <h5 class="mt-3">Processing your order...</h5>
            </div>
        </div>

        <div class="container-fluid">
            <!-- Header -->
            <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
            <div class="container">
                <h1 class="navbar-brand mb-0">
                <i class="bi bi-cart-check me-2"></i>Checkout
                </h1>
                <div class="navbar-nav ms-auto">
                <a class="nav-link text-white me-3" href="index.html">
                    <i class="bi bi-house me-1"></i>Home
                </a>
                <a class="nav-link text-white me-3" href="cart.html">
                    <i class="bi bi-bag me-1"></i>Cart
                </a>
                <!-- <button class="btn btn-outline-light btn-sm">
                    <i class="bi bi-box-arrow-right me-1"></i>Logout
                </button> -->
                </div>
            </div>
            </nav>

            <!-- Main Checkout Section -->
            <div id="checkoutSection">
            <div class="row">
                <!-- Left Column - Form -->
                <div class="col-lg-8">
                <form id="checkoutForm">
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="bi bi-person me-2 text-primary"></i>Personal Information</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold" >Full Name *</label>
                                    <input type="text" id="fullName" name="fullName" class="form-control" placeholder="Enter your full name" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold">Mobile Number *</label>
                                    <input type="tel" id="mobileNumber" name="mobileNumber" class="form-control" placeholder="10-digit mobile number" required pattern="[0-9]{10}">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold">Alternative Mobile Number</label>
                                    <input type="tel" id="altMobileNumber" name="altMobileNumber" class="form-control" placeholder="Optional" pattern="[0-9]{10}">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold">Email Address </label>
                                    <input type="email" id="emailAddress" name="emailAddress" class="form-control" placeholder="your.email@example.com">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="bi bi-geo-alt me-2 text-primary"></i>Delivery Address</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Full Address *</label>
                                <textarea id="fullAddress" class="form-control" name="fullAddress" rows="3" placeholder="House/Building no, Street, Landmark" required></textarea>
                            </div>
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="form-label fw-bold">City *</label>
                                    <input type="text" id="city" class="form-control" name="city" placeholder="City name" required>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label fw-bold">State *</label>
                                    <input type="text" id="state" class="form-control" name="state" value="West Bengal" required>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label fw-bold">PIN Code *</label>
                                    <input type="number" id="pinCode" class="form-control" name="pinCode" placeholder="6-digit PIN code" required pattern="[0-9]{6}">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="bi bi-credit-card me-2 text-primary"></i>Payment Method</h5>
                        </div>
                        <div class="card-body">
                            <div class="form-check p-3 border rounded mb-3">
                            <input class="form-check-input" type="radio" name="payment" id="cod" value="Cash on Delivery" required>
                            <label class="form-check-label w-100" for="cod">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>Cash on Delivery (COD)</strong>
                                        <small class="text-muted d-block">Pay when your order arrives</small>
                                    </div>
                                    <span class="badge bg-warning"> Potentially +‚Çπ5 charge</span>
                                </div>
                                    <div id="cod-timer-section" class="mt-2 text-center p-2 rounded bg-light" style="display: none;">
                                        <p class="mb-1 text-success fw-bold">
                                            üéâ Place your order within <span id="cod-timer">01:00</span> and your extra COD charge will refuse!
                                        </p>
                                        <p id="cod-hurry-message" class="mb-0 text-danger fw-bold" style="display: none;">
                                            ‚è∞ Hurry up! Offer ending soon!
                                        </p>
                                    </div>
                                </label>
                            </div>
                            <div class="form-check p-3 border rounded">
                                <input class="form-check-input" type="radio" name="payment" id="upi" value="UPI Payment" required>
                                <label class="form-check-label w-100" for="upi">
                                    <strong>UPI Payment</strong>
                                    <small class="text-muted d-block">After placing your order we shall contact you soon for your payment</small>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="d-grid">
                        <button type="submit" class="btn btn-success btn-lg">
                            <i class="bi bi-check-circle me-2"></i>Place Order
                        </button>
                    </div>
                </form>
                <!-- Right Column - Order Summary -->
                <div class="col-lg-4">
                    <div class="card sticky-top">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">
                                <i class="bi bi-receipt me-2"></i>Order Summary
                            </h5>
                        </div>
                        <div class="card-body">
                            <div id="checkout-cart-items">
                                <p class="text-muted">Loading cart...</p>
                            </div>
                            <hr>
                            <div class="d-flex justify-content-between align-items-center">
                                <h4 class="mb-0">Total:</h4>
                                <h4 class="mb-0 text-success">‚Çπ<span id="checkout-total">0</span></h4>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            </div>
        </div>
    
        <script>
            // Global variables for the COD timer
            let codTimerInterval;
            let timerEndTime; // This will now be set only once

            // Function to start (or resume showing) the 5-minute timer
            function startCodTimer() {
                const fiveMinutes = 1 * 60 * 1000;

                // --- KEY CHANGE ---
                // Only set the timer's end time if it hasn't been set before.
                // This makes the timer persistent.
                if (!timerEndTime) {
                    console.log("Timer started for the first time.");
                    timerEndTime = Date.now() + fiveMinutes;
                }

                // Show the timer section
                document.getElementById('cod-timer-section').style.display = 'block';
                
                // Clear any previous *display* interval to prevent duplicates
                clearInterval(codTimerInterval);

                // Start the interval to update the timer display
                codTimerInterval = setInterval(() => {
                    const remaining = timerEndTime - Date.now();

                    if (remaining <= 0) {
                        clearInterval(codTimerInterval);
                        document.getElementById('cod-timer-section').innerHTML = '<p class="text-danger fw-bold">üòî The offer has expired. A ‚Çπ5 charge will apply for choosing COD.</p>';
                        return;
                    }

                    // Show "Hurry Up" message in the last 3 minutes
                    if (remaining < 0.5 * 60 * 1000) {
                        document.getElementById('cod-hurry-message').style.display = 'block';
                    } else {
                        document.getElementById('cod-hurry-message').style.display = 'none';
                    }

                    const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((remaining % (1000 * 60)) / 1000);
                    
                    // Format to always show two digits
                    const formattedTime = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                    document.getElementById('cod-timer').textContent = formattedTime;

                }, 1000);
            }

            // Function to hide the timer (but not stop it)
            function stopCodTimer() {
                // --- KEY CHANGE ---
                // We only hide the timer display. We DO NOT clear the interval.
                // The countdown continues in the background.
                clearInterval(codTimerInterval); // Stops the display update to save resources
                document.getElementById('cod-timer-section').style.display = 'none';
            }

            // Load cart data from sessionStorage
            function loadCheckoutCart() {
                const cart = JSON.parse(sessionStorage.getItem('checkoutCart')) || [];
                const totalPrice = sessionStorage.getItem('checkoutTotalPrice') || "0";
                const cartContainer = document.getElementById('checkout-cart-items');
                const totalEl = document.getElementById('checkout-total');
                if (cart.length === 0) {
                    cartContainer.innerHTML = `<p class="text-muted">Your cart is empty.</p>`;
                    totalEl.textContent = "0.00";
                    return;
                }
                let cartHTML = "";
                cart.forEach(item => {
                    cartHTML += `<div class="d-flex justify-content-between mb-2"><span>${item.name} [${item.amount}] (x${item.quantity})</span><span class="fw-bold">‚Çπ${(item.price * item.quantity).toFixed(2)}</span></div>`;
                });
                cartContainer.innerHTML = cartHTML;
                totalEl.textContent = totalPrice;
            }

            // Handle checkout form submit
            // REPLACE your existing "submit" function with this one

            document.getElementById("checkoutForm").addEventListener("submit", function(e) {
                e.preventDefault();
                const form = e.target;
                
                document.getElementById('loadingOverlay').style.display = 'flex';

                // 1. Validate required fields
                const name = document.getElementById("fullName").value.trim();
                const mobile = document.getElementById("mobileNumber").value.trim();
                const address = document.getElementById("fullAddress").value.trim();
                const city = document.getElementById("city").value.trim();
                const state = document.getElementById("state").value.trim();
                const pincode = document.getElementById("pinCode").value.trim();
                const payment = document.querySelector("input[name='payment']:checked")?.value;

                // Email is not required, so it's removed from this check
                if (!name || !mobile || !address || !city || !state || !pincode || !payment) {
                    alert("Please fill all required fields marked with *.");
                    document.getElementById('loadingOverlay').style.display = 'none';
                    return;
                }

                // 2. Collect and calculate all data
                const cart = JSON.parse(sessionStorage.getItem('checkoutCart')) || [];
                let subTotal = parseFloat(sessionStorage.getItem('checkoutTotalPrice') || "0");
                let codCharge = 0;

                if (payment === "Cash on Delivery" && (!timerEndTime || Date.now() > timerEndTime)) {
                    codCharge = 5;
                }
                const totalPrice = subTotal + codCharge;

                // FIXED: Removed [${item.amount}] which caused errors
                const orderSummaryText = cart.map(item => 
                    `${item.name} [${item.amount}] | (Qty: ${item.quantity}) ‚Çπ${(item.price * item.quantity).toFixed(2)}`
                ).join('; ');

                const orderId = 'AD-' + Date.now();

                // 3. Prepare data for Google Sheet using FormData
                const formData = new FormData(form);
                formData.append('orderId', orderId);
                formData.append('orderSummary', orderSummaryText);
                formData.append('paymentMethod', payment);
                formData.append('codCharge', codCharge.toFixed(2));
                formData.append('total', totalPrice.toFixed(2));
                
                // 4. Send data to your Google Apps Script URL
                const scriptURL = 'https://script.google.com/macros/s/AKfycbyhVYuvC_cyTvQ4QZpPNjxfgrdlzLbWHv8O56_6GB19nxCwDIVc9fKC2ODQS7UuxQ1_8g/exec';

                fetch(scriptURL, { method: 'POST', body: formData })
                    .then(response => response.json())
                    .then(data => {
                        if (data.result === 'success') {
                            console.log('Success! Data sent to Google Sheet:', data);
                            // 5. If successful, proceed to WhatsApp
                            alert("Order data saved! You will now be redirected to WhatsApp to confirm your order.");

                            let message = ` *New Order Confirmation*\n\n`;
                            message += `*Order ID:* ${orderId}\n\n`;
                            message += ` *Customer:* ${formData.get('fullName')} (${formData.get('mobileNumber')})\n`;
                            message += ` *Address:* ${formData.get('fullAddress')}, ${formData.get('city')}, ${formData.get('state')} - ${formData.get('pinCode')}\n\n`;
                            message += ` *Order Summary:*\n`;
                            cart.forEach(item => {
                                message += `- ${item.name} [${item.amount}] | Qty: ${item.quantity} | Subtotal: ‚Çπ${(item.price * item.quantity).toFixed(2)}\n`;
                            });
                            message += ` *Payment Method:* ${payment}\n`;
                            if (codCharge > 0) {
                                message += `*COD Charge:* ‚Çπ${codCharge.toFixed(2)}\n`;
                            } else if (payment === "Cash on Delivery") {
                                message += `*COD Charge:* ‚Çπ0.00 (Offer Applied!)\n`;
                            }
                            message += ` *Grand Total:* ‚Çπ${totalPrice.toFixed(2)}\n`;

                            localStorage.removeItem('cart');
                            sessionStorage.clear();

                            const phone = "917797445647";
                            const waUrl = `https://wa.me/${phone}?text=${encodeURIComponent(message)}`;
                            window.location.href = waUrl;

                        } else {
                            // This handles errors reported by the Google Script itself
                            throw new Error(data.error || 'An unknown error occurred in the Google Script.');
                        }
                    })
                    .catch(error => {
                        console.error('Fetch Error!', error.message);
                        document.getElementById('loadingOverlay').style.display = 'none';
                        alert('There was an error saving your order. Please check your connection and try again.');
                    });
            });

            // Init on page load
            document.addEventListener("DOMContentLoaded", function() {
                loadCheckoutCart();
                document.getElementById('cod').addEventListener('change', startCodTimer);
                document.getElementById('upi').addEventListener('change', stopCodTimer);
            });
        </script>

    </body>
</html>
