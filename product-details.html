<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Product Details</title>
        <link rel="shortcut icon" href="LocaalRapid.ico" type="image/x-icon">
        <link rel="icon" href="LocaalRapid.ico" type="image/x-icon">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
        <link rel="stylesheet" href="product-detail.css">
        <script src="products.js"></script>

        <style>
            .add-cart.disabled, .product-card button.disabled {
                background-color: #ccc;
                cursor: not-allowed;
                opacity: 0.7;
            }
        </style>
    </head>
    <body>
        <header>
             <div class="navbar">
                <div class="nav-logo border" onclick="window.location.href='index.html'">
                    <div class="logo-name">LocaalRapid</div>
                    <div class="logo" load="lazy"></div>
                </div>
                <div class="cart border" onclick="window.location.href='cart.html'">
                    <span class="cart-amount">0</span>
                    <div class="cart-icon">
                        <span><i class="fa-solid fa-cart-arrow-down"></i></span>
                    </div>
                </div>
            </div>
        </header>
        <main>
            <div class="container">
                <div class="product">
                    <div class="product-gallery">
                        <img id="main-image" src="" alt="Product Image">
                        <div class="thumbnail-container"></div>
                    </div>
                    <div class="product-info" id="product-info"></div>
                </div>
            </div>

            <div class="reviews">
                <a href="https://forms.gle/o6QnsSHPTd5EUZ2q6" target="_blank" class="feedback-btn">
                    Share Your Experience With Us
                </a>
            </div>

            <div class="recommended-container">
                <div class="recommended-title">You may also like</div>
                <div class="product-scroll" id="related-products-scroll"></div>
            </div>

            <div class="recommended-container">
                <div class="recommended-title">Discover More Products</div>
                <div class="product-scroll" id="random-products-scroll-1"></div>
            </div>

            <div class="recommended-container">
                <div class="recommended-title">Just For You</div>
                <div class="product-scroll" id="random-products-scroll-2"></div>
            </div>

            <div class="qa-section">
                <h2 class="qa-title">Questions & Answers</h2>
                <div id="qa-display-container">
                    <p class="qa-loading">Loading questions...</p>
                </div>
                <div class="qa-form-container">
                    <h3>Have a question? Ask here!</h3>
                    <form id="qa-form">
                        <textarea id="question-input" name="question" placeholder="Type your question about this product..." required></textarea>
                        <div id="qa-message"></div>
                        <button type="submit" id="qa-submit-btn">Submit Question</button>
                    </form>
                </div>
            </div>
        </main>

        <footer></footer>

        <script>
        // This is the ONLY place the URL should be. This is correct.
        const G_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyv6M-KtVNR4Ed5DHioXNnZPBzodm7BldxebP7i9hhvitHZp9d3w1KfWKWjnIdMdTt-/exec';

        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const productId = parseInt(urlParams.get("id"));
            const product = products.find(p => p.id === productId);

            if (product) {
                document.title = `${product.name} - LocaalRapid`;
                renderProductDetails(product);
                fetchAndDisplayQA(productId);
                setupQAForm(productId);
                displayRecommendedProducts(product, 'related-products-scroll');
                displayRandomProducts(productId, 'random-products-scroll-1', 10);
                displayRandomProducts(productId, 'random-products-scroll-2', 10);
            } else {
                document.querySelector('.container').innerHTML = '<h1>Product not found!</h1><p><a href="index.html">Go back to shop</a></p>';
                document.querySelector('.recommended-container').style.display = 'none';
            }
            updateCartCount();
        });

        function renderProductDetails(product) {
            const discount = ((product.originalPrice - product.price) / product.originalPrice) * 100;
            const discountpercent = discount.toFixed(2);
            const discountText = discountpercent > 0 ? `${discountpercent}%` : "Best Quality";
            const discountHTML = `<span class="discount-percent"><i class="fa-solid fa-arrow-down"></i> ${discountText}</span>`;

            const productInfoContainer = document.getElementById('product-info');
            const priceHTML = (product.price === product.originalPrice || !product.originalPrice)
                ? `₹${product.price}`
                : `${discountpercent > 0 ? discountHTML : ''}<del>₹${product.originalPrice}</del> ₹${product.price}  `;

            productInfoContainer.innerHTML = `
                <h1><abbr style="text-decoration: none;" title="${product.name}">${product.name} </abbr></h1>
                <p>${product.message ? `<p class="message" style="font-size:0.7em;position:relative;bottom:-10px;"> ${product.message} </p>` : ''}</p>
                <p class="price"> ${priceHTML}</p>
                <p class="tax">(Inclusive of all taxes)</p>
                <p class="product-location">Product Location: Home / ${product.location} / ${product.name}</p>
                <div id="countdown-container"></div>
                ${product.delivery_time ? `<p class="delivery_time"><img src="delivery-man.png" alt="Delivery" width="30px" height="30px"> Your order is expected to arrive in approximately ${product.delivery_time} </p>` : ''}

                <p class="product-subcategory">${product.sub_category || 'no sub category'}</p>
                <p class="product-message">${product.little_details || ''}</p>
                <div class="product-details">
                    <h2 class="product-details-head">Product Full Details</h2>
                    <p class="product-details">Amount: ${product.amount || 'Amount has not been published'} <br> ${product.details || 'No more additional details are available.'}</p>
                </div>
                <button class="add-cart"><i class="fa-solid fa-cart-plus"></i> Add to Cart</button>
            `;

            const addButton = productInfoContainer.querySelector('.add-cart');
            addButton.addEventListener('click', () => addToCart(product));

            if (product.timer) {
                startCountdown(product.timer, addButton, 'countdown-container', 'countdown-timer');
            }

            document.getElementById('main-image').src = product.image;
            document.getElementById('main-image').alt = product.name;
            const thumbnailContainer = document.querySelector('.thumbnail-container');
            thumbnailContainer.innerHTML = `
                <img class="thumbnail" src="${product.thumbnail1 || product.image}" alt="${product.name} thumbnail 1">
                <img class="thumbnail" src="${product.thumbnail2 || product.image}" alt="${product.name} thumbnail 2">
                <img class="thumbnail" src="${product.thumbnail3 || product.image}" alt="${product.name} thumbnail 3">
            `;
            document.querySelectorAll('.thumbnail').forEach(thumb => {
                thumb.addEventListener('click', (e) => {
                    document.getElementById('main-image').src = e.target.src;
                });
            });
        }

        // ====== CART MANAGEMENT ======
        function getCart() { return JSON.parse(localStorage.getItem("cart")) || []; }
        function saveCart(cart) { localStorage.setItem("cart", JSON.stringify(cart)); }
        function updateCartCount() {
            const cart = getCart();
            const count = cart.reduce((sum, item) => sum + item.quantity, 0);
            document.querySelector(".cart-amount").textContent = count;
        }
        function addToCart(product) {
            let cart = getCart();
            const index = cart.findIndex(item => item.id === product.id);
            if (index !== -1) { cart[index].quantity += 1; }
            else { cart.push({ ...product, quantity: 1 }); }
            saveCart(cart);
            updateCartCount();
            alert(`${product.name} added to cart!`);
        }
        document.addEventListener("DOMContentLoaded", updateCartCount);

        // ====== COUNTDOWN TIMER ======
        function startCountdown(timerString, buttonElement, timerContainerId, timerClass) {
            const countdownContainer = document.getElementById(timerContainerId);
            if (!countdownContainer) return;
            const countDownDate = new Date(timerString).getTime();
            const countdownInterval = setInterval(function() {
                const now = new Date().getTime();
                const distance = countDownDate - now;
                if (distance > 0) {
                    const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                    countdownContainer.innerHTML = `<div class="${timerClass}">Deal Ends In: ${days}d ${hours}h ${minutes}m ${seconds}s</div>`;
                } else {
                    clearInterval(countdownInterval);
                    countdownContainer.innerHTML = `<div class="${timerClass}">DEAL EXPIRED</div>`;
                    if(buttonElement) {
                        buttonElement.disabled = true;
                        buttonElement.textContent = 'Deal Expired';
                        buttonElement.classList.add('disabled');
                    }
                }
            }, 1000);
        }

        // --- REFACTORED CARD CREATION LOGIC ---
        function createProductCardHTML(product) {
            let originalPriceDisplay = '';
            let discountDisplay = '';

            if (product.originalPrice && product.originalPrice > 0 && product.originalPrice !== product.price) {
                originalPriceDisplay = `<span style="color:red; text-decoration:line-through; margin-left: 8px;">₹${product.originalPrice}</span>`;
                const discount = ((product.originalPrice - product.price) / product.originalPrice) * 100;
                discountDisplay = `<span style="color:green; margin-left: 5px;"><i class="fa-solid fa-arrow-down"></i>${discount.toFixed(2)}%</span>`;
            }

            return `
                <a href="product-details.html?id=${product.id}" class="product-card">
                    <img src="${product.image}" alt="${product.name}">
                    <h4><abbr style="text-decoration: none;" title="${product.name}">${product.name}</abbr></h4>
                    <div class="div-delivery_time">
                       ${product.delivery_time ? `<p class="delivery_time-rec" style="font-size:10px;"><i class="fa-solid fa-clock"></i> ${product.delivery_time} </p>` : ''}
                    </div>
                    ${product.timer ? `<div id="timer-${product.id}"></div>` : ''}
                    ${product.message ? `<p class="message"> ${product.message} </p>` : ''}
                    <div class="product-amount">${product.amount || ''}</div>
                    <div class="little_details">${product.little_details}</div>
                    <p>${discountDisplay}${originalPriceDisplay} ₹${product.price}</p>
                    <button data-product-id="${product.id}" id="button-${product.id}">Add to Cart</button>
                </a>
            `;
        }

        // --- GENERALIZED RECOMMENDED PRODUCTS LOGIC ---
        function renderProducts(productsToShow, containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            container.innerHTML = '';

            if (productsToShow.length === 0) {
                container.parentElement.style.display = 'none';
                return;
            }

            productsToShow.forEach(product => {
                container.innerHTML += createProductCardHTML(product);
            });

            productsToShow.forEach(product => {
                if (product.timer) {
                    const recButton = document.getElementById(`button-${product.id}`);
                    const recTimerContainerId = `timer-${product.id}`;
                    if (recButton && document.getElementById(recTimerContainerId)) {
                        startCountdown(product.timer, recButton, recTimerContainerId, 'rec-countdown-timer');
                    }
                }
            });

            container.querySelectorAll('.product-card button').forEach(button => {
                button.addEventListener('click', function(event) {
                    event.preventDefault();
                    event.stopPropagation();
                    const productId = parseInt(this.dataset.productId);
                    const productToAdd = products.find(p => p.id === productId);
                    if (productToAdd) {
                        addToCart(productToAdd);
                    }
                });
            });
        }

        function displayRecommendedProducts(currentProduct, containerId) {
            const recommendations = products
                .filter(p => p.category === currentProduct.category && p.id !== currentProduct.id)
                .sort(() => 0.5 - Math.random())
                .slice(0, 15);
            renderProducts(recommendations, containerId);
        }

        function displayRandomProducts(currentProductId, containerId, count) {
            const recommendations = products
                .filter(p => p.id !== currentProductId)
                .sort(() => 0.5 - Math.random())
                .slice(0, count);
            renderProducts(recommendations, containerId);
        }

        // --- Q&A FUNCTIONS ---
        async function fetchAndDisplayQA(productId) {
            const container = document.getElementById('qa-display-container');
            // CORRECTED: This now checks for the original placeholder string.
            if (!G_SCRIPT_URL || G_SCRIPT_URL === 'YOUR_GOOGLE_APPS_SCRIPT_URL') {
                container.innerHTML = '<p class="qa-error">Q&A feature is not configured.</p>';
                return;
            }

            try {
                const response = await fetch(`${G_SCRIPT_URL}?productId=${productId}`);
                const result = await response.json();

                if (result.status === 'success' && result.data.length > 0) {
                    container.innerHTML = ''; // Clear loading message
                    result.data.forEach(item => {
                        const qaPair = document.createElement('div');
                        qaPair.className = 'qa-pair';
                        qaPair.innerHTML = `
                            <div class="qa-question"><strong>Q:</strong> ${item.question}</div>
                            <div class="qa-answer"><strong>A:</strong> ${item.answer}</div>
                        `;
                        container.appendChild(qaPair);
                    });
                } else {
                    container.innerHTML = '<p class="qa-none">Be the first to ask a question about this product!</p>';
                }
            } catch (error) {
                console.error('Error fetching Q&A:', error);
                container.innerHTML = '<p class="qa-error">Could not load questions and answers at this time.</p>';
            }
        }

        function setupQAForm(productId) {
            const form = document.getElementById('qa-form');
            const submitBtn = document.getElementById('qa-submit-btn');
            const messageDiv = document.getElementById('qa-message');
            const questionInput = document.getElementById('question-input');

            form.addEventListener('submit', async function(event) {
                event.preventDefault();
                submitBtn.disabled = true;
                submitBtn.textContent = 'Submitting...';
                messageDiv.textContent = '';

                // CORRECTED: This now checks for the original placeholder string.
                if (!G_SCRIPT_URL || G_SCRIPT_URL === 'YOUR_GOOGLE_APPS_SCRIPT_URL') {
                    messageDiv.textContent = 'Q&A feature is not configured.';
                    messageDiv.className = 'qa-message-error';
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Submit Question';
                    return;
                }

                try {
                    const response = await fetch(G_SCRIPT_URL, {
                        method: 'POST',
                        mode: 'cors',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            productId: productId,
                            question: questionInput.value
                        })
                    });

                    const result = await response.json();

                    if(result.status === 'success') {
                        messageDiv.textContent = 'Thank you! Your question has been submitted for review.';
                        messageDiv.className = 'qa-message-success';
                        questionInput.value = ''; // Clear the textarea
                    } else {
                        throw new Error(result.message || 'Unknown error');
                    }

                } catch (error) {
                    messageDiv.textContent = `Submission failed: ${error.message}`;
                    messageDiv.className = 'qa-message-error';
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Submit Question';
                }
            });
        }
        </script>
    </body>
</html>