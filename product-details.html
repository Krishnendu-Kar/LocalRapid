<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Product Details</title>
        <link rel="shortcut icon" href="LocaalRapid.ico" type="image/x-icon">
        <link rel="icon" href="LocaalRapid.ico" type="image/x-icon">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
        <link rel="stylesheet" href="product-detail.css">
        <script src="products.js"></script>

        <style>
            
            .add-cart.disabled, .product-card button.disabled {
                background-color: #ccc;
                cursor: not-allowed;
                opacity: 0.7;
            }
        </style>
        </head>
    <body>
        <header>
             <div class="navbar">
                <div class="nav-logo border" onclick="window.location.href='index.html'">
                    <div class="logo-name">LocaalRapid</div>
                    <div class="logo" load="lazy"></div>
                </div>
                <div class="cart border" onclick="window.location.href='cart.html'">
                    <span class="cart-amount">0</span>
                    <div class="cart-icon">
                        <span><i class="fa-solid fa-cart-arrow-down"></i></span>
                    </div>
                </div>
            </div>
        </header>
        <main>
            <div class="container">
                <div class="product">
                    <div class="product-gallery">
                        <img id="main-image" src="" alt="Product Image">
                        <div class="thumbnail-container"></div>
                    </div>
                    <div class="product-info" id="product-info"></div>
                </div>
            </div>

            <div class="reviews">
                <a href="https://forms.gle/o6QnsSHPTd5EUZ2q6" target="_blank" class="feedback-btn">
                    Share Your Experience With Us
                </a>
            </div>
            <div class="recommended-container">
                <div class="recommended-title">You may also like</div>
                <div class="product-scroll"></div>
            </div>
        </main>
        <footer></footer>
        <script>
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const productId = parseInt(urlParams.get("id"));
            const product = products.find(p => p.id === productId);

            if (product) {
                document.title = `${product.name} - LocaalRapid`;

                const discount = ((product.originalPrice - product.price) / product.originalPrice) * 100;
                const discountpercent = discount.toFixed(2);
                const discountText = discountpercent > 0 ? `${discountpercent}%` : "Best Quality";
                const discountHTML = `<span class="discount-percent"><i class="fa-solid fa-arrow-down"></i> ${discountText}</span>`;

                const productInfoContainer = document.getElementById('product-info');
                const priceHTML = (product.price === product.originalPrice || !product.originalPrice)
                    ? `₹${product.price}`
                    : `${discountpercent > 0 ? discountHTML : ''}<del>₹${product.originalPrice}</del> ₹${product.price}  `;

                productInfoContainer.innerHTML = `
                    <h1><abbr style="text-decoration: none;" title="${product.name}">${product.name} </abbr></h1>
                    <p>${product.message ? `<p class="message" style="font-size:0.7em;position:relative;bottom:-10px;"> ${product.message} </p>` : ''}</p>
                    <p class="price"> ${priceHTML}  </p>
                    <div id="countdown-container"></div> 
                    ${product.delivery_time ? `<p class="delivery_time"><img src="delivery-man.png" alt="UPI" width="30px" height="30px"> Your order is expected to arrive in approximately ${product.delivery_time} </p>` : ''}
                    
                    <p class="product-subcategory">${product.sub_category || 'no sub category'}</p>
                    <p class="product-message">${product.little_details || ''}</p>
                    <div class="product-details">
                        <h2 class="product-details-head">Product Full Details</h2>
                        <p class="product-details">Amount: ${product.amount || 'Amount has not been published'} <br> ${product.details || 'No more additional details are available.'}</p>
                    </div>
                    <button class="add-cart"><i class="fa-solid fa-cart-plus"></i> Add to Cart</button>
                `;

                const addButton = productInfoContainer.querySelector('.add-cart');
                addButton.addEventListener('click', () => {
                    addToCart(product);
                });

                // --- CHANGE: Updated call to the more versatile function ---
                if (product.timer) {
                    startCountdown(product.timer, addButton, 'countdown-container', 'countdown-timer');
                }
                
                document.getElementById('main-image').src = product.image;
                document.getElementById('main-image').alt = product.name;
                const thumbnailContainer = document.querySelector('.thumbnail-container');
                thumbnailContainer.innerHTML = `
                    <img class="thumbnail" src="${product.thumbnail1 || product.image}" alt="${product.name} thumbnail 1">
                    <img class="thumbnail" src="${product.thumbnail2 || product.image}" alt="${product.name} thumbnail 2">
                    <img class="thumbnail" src="${product.thumbnail3 || product.image}" alt="${product.name} thumbnail 3">
                `;
                document.querySelectorAll('.thumbnail').forEach(thumb => {
                    thumb.addEventListener('click', (e) => {
                        document.getElementById('main-image').src = e.target.src;
                    });
                });
                displayRecommendedProducts(product);
            } else {
                document.querySelector('.container').innerHTML = '<h1>Product not found!</h1><p><a href="index.html">Go back to shop</a></p>';
                document.querySelector('.recommended-container').style.display = 'none';
            }
            updateCartCount();
        });

        // ====== CART MANAGEMENT (No changes) ======
        function getCart() { return JSON.parse(localStorage.getItem("cart")) || []; }
        function saveCart(cart) { localStorage.setItem("cart", JSON.stringify(cart)); }
        function updateCartCount() {
            const cart = getCart();
            const count = cart.reduce((sum, item) => sum + item.quantity, 0);
            document.querySelector(".cart-amount").textContent = count;
        }
        function addToCart(product) {
            let cart = getCart();
            const index = cart.findIndex(item => item.id === product.id);
            if (index !== -1) { cart[index].quantity += 1; } 
            else { cart.push({ ...product, quantity: 1 }); }
            saveCart(cart);
            updateCartCount();
            alert(`${product.name} added to cart!`);
        }
        document.addEventListener("DOMContentLoaded", updateCartCount);

        // --- CHANGE START: Updated the countdown function to be more generic ---
        function startCountdown(timerString, buttonElement, timerContainerId, timerClass) {
            const countdownContainer = document.getElementById(timerContainerId);
            if (!countdownContainer) return; 

            const countDownDate = new Date(timerString).getTime();

            const countdownInterval = setInterval(function() {
                const now = new Date().getTime();
                const distance = countDownDate - now;

                if (distance > 0) {
                    const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                    countdownContainer.innerHTML = `
                        <div class="${timerClass}">
                           Deal Ends In: ${days}d ${hours}h ${minutes}m ${seconds}s
                        </div>
                    `;
                } else {
                    clearInterval(countdownInterval);
                    countdownContainer.innerHTML = `<div class="${timerClass}">DEAL EXPIRED</div>`;
                    buttonElement.disabled = true;
                    buttonElement.textContent = 'Deal Expired';
                    buttonElement.classList.add('disabled');
                }
            }, 1000);
        }
        // --- CHANGE END ---

        // ====== RECOMMENDED PRODUCTS (Logic updated) ======
function displayRecommendedProducts(currentProduct) {
            const recommendedContainer = document.querySelector('.product-scroll');
            recommendedContainer.innerHTML = '';

            const recommendations = products
                .filter(p => p.category === currentProduct.category && p.id !== currentProduct.id)
                .sort(() => 0.5 - Math.random())
                .slice(0, 10);

            if (recommendations.length === 0) {
                document.querySelector('.recommended-container').style.display = 'none';
                return;
            }

           recommendations.forEach(recProduct => {
    let originalPriceDisplay = '';
    let discountDisplay = '';

    // Only show original price and discount if originalPrice > 0 and different from current price
    if (recProduct.originalPrice && recProduct.originalPrice > 0 && recProduct.originalPrice !== recProduct.price) {
        originalPriceDisplay = `<span style="color:red; text-decoration:line-through; margin-left: 8px;">₹${recProduct.originalPrice}</span>`;
        
        const discount = ((recProduct.originalPrice - recProduct.price) / recProduct.originalPrice) * 100;
        discountDisplay = `<span style="color:green; margin-left: 5px;"><i class="fa-solid fa-arrow-down"></i>${discount.toFixed(2)}%</span>`;
    }

    const cardHTML = `
        <a href="product-details.html?id=${recProduct.id}" class="product-card">
            <img src="${recProduct.image}" alt="${recProduct.name}">
            <h4><abbr style="text-decoration: none;" title="${recProduct.name}">${recProduct.name}</abbr></h4>
            <div class="div-delivery_time">
               ${recProduct.delivery_time ? `<p class="delivery_time-rec" style="font-size:10px;"><i class="fa-solid fa-clock"></i> ${recProduct.delivery_time} </p>` : ''} 
            </div>
            ${recProduct.timer ? `<div id="timer-${recProduct.id}"></div>` : ''}
            ${recProduct.message ? `<p class="message"> ${recProduct.message} </p>` : ''}
            <div class="product-amount">${recProduct.amount || ''}</div>
            <div class="little_details">${recProduct.little_details}</div>
            <p>${discountDisplay}${originalPriceDisplay} ₹${recProduct.price}  </p> 
            <button data-product-id="${recProduct.id}" id="button-${recProduct.id}">Add to Cart</button>
        </a>
    `;

                recommendedContainer.innerHTML += cardHTML;
            });

            // This part remains the same, it will now only find timers that were actually created
            recommendations.forEach(recProduct => {
                if (recProduct.timer) {
                    const recButton = document.getElementById(`button-${recProduct.id}`);
                    const recTimerContainerId = `timer-${recProduct.id}`;
                    if (recButton && recTimerContainerId) {
                        startCountdown(recProduct.timer, recButton, recTimerContainerId, 'rec-countdown-timer');
                    }
                }
            });

            recommendedContainer.querySelectorAll('.product-card button').forEach(button => {
                button.addEventListener('click', function(event) {
                    event.preventDefault(); 
                    event.stopPropagation();
                    const productId = parseInt(this.dataset.productId);
                    const productToAdd = products.find(p => p.id === productId);
                    if (productToAdd) {
                        addToCart(productToAdd);
                    }
                });
            });
        }
        </script>
    </body>
</html>